---
// SearchBar.astro - Pagefind integration
---

<div class="relative max-w-md mx-auto">
  <label for="search-input" class="sr-only">Search posts</label>
  <input
    type="search"
    placeholder="Search..."
    class="w-full px-4 py-2 bg-tokyo-surface border border-tokyo-border rounded-lg text-tokyo-text placeholder-tokyo-muted focus:outline-none focus:border-tokyo-accent"
    id="search-input"
    aria-label="Search posts"
    autocomplete="off"
  />

  <div id="search-results" class="absolute top-full mt-2 w-full bg-tokyo-surface border border-tokyo-border rounded-lg shadow-lg hidden" aria-live="polite">
    <!-- Results populated by client script -->
  </div>
</div>

<script type="module" client:idle>
(() => {
  const INPUT_ID = 'search-input';
  const RESULTS_ID = 'search-results';
  const MIN_CHARS = 2;
  const DEBOUNCE_MS = 300;

  const input = document.getElementById(INPUT_ID);
  const resultsEl = document.getElementById(RESULTS_ID);

  let pagefindReady = false;
  let loadingPagefind = false;
  let debounceTimer = null;
  let inFlight = false;
  let currentResults = [];
  let focusedIndex = -1; // -1 means input

  function showContainer() {
    resultsEl.classList.remove('hidden');
  }
  function hideContainer() {
    resultsEl.classList.add('hidden');
  }
  function clearResults() {
    currentResults = [];
    focusedIndex = -1;
    renderResults();
    hideContainer();
  }

  function setSearchingState() {
    resultsEl.innerHTML = '<div class="p-3 text-sm text-tokyo-muted">Searching...</div>';
    showContainer();
  }

  function setErrorState(msg) {
    resultsEl.innerHTML = `<div class="p-3 text-sm text-red-400">${msg} <button id=\"search-reload\" class=\"ml-2 underline\">Reload</button></div>`;
    showContainer();
    const btn = document.getElementById('search-reload');
    if (btn) btn.addEventListener('click', () => location.reload());
  }

  async function loadPagefind() {
    if (pagefindReady) return window.pagefind;
    if (loadingPagefind) {
      // wait until ready
      return new Promise((resolve, reject) => {
        const i = setInterval(() => {
          if (window.pagefind && typeof window.pagefind.search === 'function') {
            clearInterval(i);
            pagefindReady = true;
            resolve(window.pagefind);
          }
        }, 50);
        // timeout after 10s
        setTimeout(() => {
          clearInterval(i);
          reject(new Error('Pagefind load timeout'));
        }, 10000);
      });
    }

    loadingPagefind = true;

    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = '/pagefind/pagefind.js';
      script.async = true;
      script.onload = () => {
        if (window.pagefind && typeof window.pagefind.search === 'function') {
          pagefindReady = true;
          resolve(window.pagefind);
        } else {
          reject(new Error('pagefind did not initialize'));
        }
      };
      script.onerror = () => reject(new Error('Failed to load /pagefind/pagefind.js'));
      document.head.appendChild(script);
    });
  }

  function renderResults() {
    if (!currentResults || currentResults.length === 0) {
      resultsEl.innerHTML = '';
      return;
    }

    const list = document.createElement('div');
    list.setAttribute('role', 'list');
    list.setAttribute('aria-label', 'Search results');

    currentResults.forEach((r, i) => {
      const item = document.createElement('div');
      item.setAttribute('role', 'listitem');
      item.className = 'border-b last:border-b-0';

      const a = document.createElement('a');
      a.href = r.url;
      a.className = 'block p-3 focus:outline-none focus:bg-tokyo-accent/10';
      a.innerHTML = `<div class=\"font-semibold text-tokyo-text\">${escapeHtml(r.title)}</div><div class=\"text-sm text-tokyo-muted mt-1\">${escapeHtml(r.excerpt || '')}</div>`;
      a.tabIndex = -1; // focusable programmatically
      a.dataset.index = String(i);

      a.addEventListener('keydown', (ev) => {
        if (ev.key === 'ArrowDown') {
          ev.preventDefault();
          focusResult(Math.min(currentResults.length - 1, i + 1));
        } else if (ev.key === 'ArrowUp') {
          ev.preventDefault();
          if (i - 1 >= 0) focusResult(i - 1);
          else input.focus();
        } else if (ev.key === 'Escape') {
          ev.preventDefault();
          clearResults();
          input.focus();
        }
        // Enter will activate the anchor by default
      });

      a.addEventListener('click', () => {
        // leave default navigation behavior
      });

      item.appendChild(a);
      list.appendChild(item);
    });

    resultsEl.innerHTML = '';
    resultsEl.appendChild(list);
    showContainer();
  }

  function focusResult(index) {
    const anchors = resultsEl.querySelectorAll('a[data-index]');
    if (!anchors || anchors.length === 0) return;
    const idx = Math.max(0, Math.min(anchors.length - 1, index));
    const node = anchors[idx];
    if (node) {
      node.focus();
      focusedIndex = idx;
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  async function doSearch(query) {
    if (!query || query.length < MIN_CHARS) {
      clearResults();
      return;
    }

    try {
      const pf = await loadPagefind();
      if (!pf || typeof pf.search !== 'function') {
        setErrorState('Search unavailable — try reloading.');
        return;
      }
    } catch (err) {
      setErrorState('Search unavailable — try reloading.');
      console.error(err);
      return;
    }

    // perform search
    inFlight = true;
    setSearchingState();
    try {
      const res = await window.pagefind.search(query);
      // map results.results
      const mapped = (res && res.results ? res.results : []).map((r) => ({
        url: r.url || '#',
        title: (r.meta && r.meta.title) ? r.meta.title : (r.url || ''),
        excerpt: r.excerpt || '',
      }));
      currentResults = mapped;
      renderResults();
    } catch (err) {
      console.error('Pagefind search failed', err);
      setErrorState('Search failed — try again or reload.');
    } finally {
      inFlight = false;
    }
  }

  // debounce wrapper
  function handleInput(e) {
    const q = e.target.value.trim();
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => doSearch(q), DEBOUNCE_MS);
  }

  // keyboard shortcuts on input
  input.addEventListener('keydown', (ev) => {
    if (ev.key === 'ArrowDown') {
      // move to first result
      ev.preventDefault();
      if (currentResults.length > 0) focusResult(0);
    } else if (ev.key === 'Escape') {
      ev.preventDefault();
      clearResults();
      input.value = '';
    } else if (ev.key === 'Enter') {
      // If results visible and a result focused via keyboard, let Enter activate; otherwise do nothing special
    }
  });

  input.addEventListener('input', handleInput);

  // Click outside to close
  document.addEventListener('click', (ev) => {
    if (!resultsEl.contains(ev.target) && ev.target !== input) {
      hideContainer();
    }
  });

  // Cleanup on blur isn't strictly necessary, but ensure Esc focuses input
  document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Escape') {
      clearResults();
      input.focus();
    }
  });

  // Prefetch pagefind when input is focused (improves perceived speed)
  input.addEventListener('focus', () => {
    if (!pagefindReady && !loadingPagefind) loadPagefind().catch((err) => {
      console.warn('Failed to prefetch pagefind', err);
    });
  });

})();
</script>
